name: Base

on:
  #workflow_dispatch:
  #  inputs:
  #    chinese:
  #      description: 'using chinese apt and pip source mirrors'
  #      default: '0'
  push:
    branches:
      - docker
jobs:
  base:
    runs-on: ubuntu-latest
    steps:
      #- name: Free disk space
      #  run: |
      #    sudo -E swapoff -a
      #    sudo -E rm -f /swapfile
      #    sudo -E docker image prune -a -f
      #    sudo -E snap set system refresh.retain=2
      #    sudo -E apt-get -y purge azure* dotnet* firefox ghc* google* hhvm llvm* mono* mysql* openjdk* php* zulu* powershell* msodbc*
      #    sudo -E apt-get -y autoremove --purge
      #    sudo -E apt-get clean
      #    sudo -E rm -rf /usr/share/dotnet /usr/local/lib/android/sdk /etc/mysql /etc/php /usr/local/share/boost
      #    [ -n "$AGENT_TOOLSDIRECTORY" ] && sudo rm -rf "$AGENT_TOOLSDIRECTORY"
      #    df -h
      - name: Checkout opde repo
        uses: actions/checkout@v2
        with:
          submodules: true
      - name: Checkout OpenWRT repo
        uses: actions/checkout@v2
        with:
          repository: immortalwrt/immortalwrt
          submodules: true
          path: ./openwrt
          ref: master
      - name: Checkout Opde database
        uses: actions/checkout@v2
        with:
          ref: gh-pages
          submodules: true
          path: ./openwrt/.opde/db
      - name: pull docker image
        run: docker pull elonh/opde:base
      - name: Fix premission
        run: docker run -v $PWD/openwrt:/openwrt elonh/opde:base sudo chown opde:opde -R /openwrt
      - name: debug # docker run -it -v $PWD:/openwrt elonh/opde:base bash
        uses: mxschmitt/action-tmate@v2
      - name: Opde feeds
        run: docker run -v $PWD/openwrt:/openwrt elonh/opde:base opde feeds
      - name: Opde patch
        run: docker run -v $PWD/openwrt:/openwrt elonh/opde:base opde patch
      - name: Opde config
        run: |
          docker run -v $PWD/openwrt:/openwrt elonh/opde:base opde config -ke -ib -sdk
          docker run -v $PWD/openwrt:/openwrt elonh/opde:base cat .opde/min-config.in
      - name: Opde download
        run: docker run -v $PWD/openwrt:/openwrt elonh/opde:base opde download
      - name: Opde build
        run: docker run -v $PWD/openwrt:/openwrt elonh/opde:base opde build
      - name: Update database
        run: |
          docker run -v $PWD/openwrt:/openwrt elonh/opde:base mkdir .opde/db -p # create database only
          docker run -v $PWD/openwrt:/openwrt elonh/opde:base opde extract .opde/db ${{github.run_number}}
      - name: Opde Assign
        run: docker run -v $PWD/openwrt:/openwrt elonh/opde:base opde assign .opde/db
      - name: Bundle Artifacts
        run: docker run -v $PWD/openwrt:/openwrt elonh/opde:base tar -czvf opde.tar.gz logs .opde
      - name: Fix premission
        run: sudo chown $(id -u -n):$(id -g -n) -R opde.tar.gz logs bin .opde
        working-directory: openwrt
      - name: Upload Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: Base
          path: ./openwrt/opde.tar.gz
      #- name: Opde check
      #  run: docker run -v $PWD/openwrt:/openwrt elonh/opde:base opde check .opde/db ${{github.run_number}}
      - id: sdk-var2
        run: |
          SDK_PATH=$(find ./openwrt/bin -name "*sdk*")
          echo "::set-output name=SDK_PATH::$SDK_PATH"
          SDK_NAME=$(basename $SDK_PATH)
          echo "::set-output name=SDK_NAME::$SDK_NAME"
          SDK_NAME_NO_PREFIX=${SDK_NAME:0:-7}
          echo "::set-output name=SDK_NAME_NO_PREFIX::$SDK_NAME_NO_PREFIX"
          IB_PATH=$(find ./openwrt/bin -name "*imagebuilder*")
          echo "::set-output name=IB_PATH::$IB_PATH"
          IB_NAME=$(basename $IB_PATH)
          echo "::set-output name=IB_NAME::$IB_NAME"
          IB_NAME_NO_PREFIX=${IB_NAME:0:-7}
          echo "::set-output name=IB_NAME_NO_PREFIX::$IB_NAME_NO_PREFIX"
      - uses: actions/upload-artifact@v2
        with:
          name: SDK
          path: ${{steps.sdk-var2.outputs.SDK_PATH}}
      - uses: actions/upload-artifact@v2
        with:
          name: ImageBuilder
          path: ${{steps.sdk-var2.outputs.IB_PATH}}
      - run: |
          tar -cf tmp.tar openwrt/bin/targets/*/*/packages
          rm openwrt/bin/targets/*/*/packages -rf
          mv ${{steps.sdk-var2.outputs.SDK_PATH}} .
          mv ${{steps.sdk-var2.outputs.IB_PATH}} .
          ls -lh openwrt/bin/targets/*/*/ || true
          ( ls openwrt/bin/targets/*/*/*.vdi >/dev/null 2>&1 ) && gzip -9n openwrt/bin/targets/*/*/*.vdi || true
          ( ls openwrt/bin/targets/*/*/*.vmdk >/dev/null 2>&1 ) && gzip -9n openwrt/bin/targets/*/*/*.vmdk || true
      - uses: actions/upload-artifact@v2
        with:
          name: Firmware
          path: ./openwrt/bin/targets
      - run: |-
          rm openwrt/bin/targets -rf
          tar -xf tmp.tar
          rm tmp.tar
      - uses: actions/upload-artifact@v2
        with:
          name: Packages-00
          path: ./openwrt/bin
      -
        name: Set up QEMU
        uses: docker/setup-qemu-action@v1
      -
        name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1
      -
        name: Login to DockerHub
        uses: docker/login-action@v1
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - run: |-
          tar -xf ${{steps.sdk-var2.outputs.SDK_NAME}}
          tar -xf ${{steps.sdk-var2.outputs.IB_NAME}}
          ls -l -h
      -
        name: Build and push sdk
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile.sdk
          platforms: linux/amd64
          build-args: |
            SDK_PATH=./${{steps.sdk-var2.outputs.SDK_NAME_NO_PREFIX}}
          push: true
          tags: |
            elonh/opde:sdk
      -
        name: Build and push worker
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile.worker
          platforms: linux/amd64
          build-args: |
            WORKER_CONF_DIR=./openwrt/.opde/worker
          push: true
          tags: |
            elonh/opde:worker
      -
        name: Build and push image builder
        uses: docker/build-push-action@v2
        with:
          context: .
          file: ./Dockerfile.ib
          platforms: linux/amd64
          build-args: |
            IB_PATH=./${{steps.sdk-var2.outputs.IB_NAME_NO_PREFIX}}
          push: true
          tags: |
            elonh/opde:ib
      #- 
      #  name: debug # docker run -it -v $PWD:/openwrt elonh/opde:base bash
      #  uses: mxschmitt/action-tmate@v2
      #  if: failure()
      # -
      #   name: Set up QEMU
      #   uses: docker/setup-qemu-action@v1
      # -
      #   name: Set up Docker Buildx
      #   uses: docker/setup-buildx-action@v1
      # -
      #   name: Login to DockerHub
      #   uses: docker/login-action@v1
      #   with:
      #     username: ${{ secrets.DOCKERHUB_USERNAME }}
      #     password: ${{ secrets.DOCKERHUB_TOKEN }}
      # - id: var
      #   run: |-
      #     dateDot=$(date +'%y.%m')
      #     echo $dateDot
      #     echo "::set-output name=dateDot::$dateDot"
      # -
      #   name: Build and push scratch
      #   uses: docker/build-push-action@v2
      #   with:
      #     context: .
      #     file: ./Dockerfile.scratch
      #     platforms: linux/amd64
      #     build-args: |
      #       CHINESE_APT_MIRRORS=${{ github.event.inputs.chinese }}
      #     push: true
      #     tags: |
      #       elonh/opde:scratch
      #       elonh/opde:scratch-${{steps.var.outputs.dateDot}}
      # -
      #   name: Build and push base
      #   uses: docker/build-push-action@v2
      #   with:
      #     context: .
      #     file: ./Dockerfile.base
      #     platforms: linux/amd64
      #     push: true
      #     tags: |
      #       elonh/opde:base
      #       elonh/opde:base-${{steps.var.outputs.dateDot}}
      # -
      #   name: Build and push dev
      #   uses: docker/build-push-action@v2
      #   with:
      #     context: .
      #     file: ./Dockerfile.dev
      #     platforms: linux/amd64
      #     build-args: |
      #       CHINESE_PIP_MIRRORS=${{ github.event.inputs.chinese }}
      #     push: true
      #     tags: |
      #       elonh/opde:dev
      #       elonh/opde:dev-${{steps.var.outputs.dateDot}}
